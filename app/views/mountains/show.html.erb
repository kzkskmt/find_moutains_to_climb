<!-- mtshow-->
<section class="mtshow-section bg-light" id="mtshow">
    <div class="container px-4 px-lg-5">
        <!-- Featured mtshow Row-->
        <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
            <div class="col-xl-8 col-lg-7"><%= image_tag @mountain.image.url, class: 'img-fluid mb-3 mb-lg-0' %></div>
            <div class="col-xl-4 col-lg-5">
                <div class="featured-text text-center text-lg-left">
                    <h4><%= @mountain.name %></h4>
                    <p class="text-black-50 mb-0">標高：<%= @mountain.elevation %>m</p>
                    <p class="text-black-50 mb-0"><%= @mountain.pref.name %> <%= @mountain.city %></p>
                    <p class="text-black-50 mb-0">--------</p>
                    <p class="text-black-50 mb-0">難易度</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 天気と服装-->
<section class="weather-section text-center" id="weather">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-lg-8">
                <h2 class="text-white mb-4">山頂の天気予報</h2>
                <!-- 山頂の天気予報表示-->
                <div id="openweather" class="d-flex mb-5"></div>
            </div>
            <div class="col-lg-8">
                <h2 class="text-white mb-4">登山口周辺の天気予報</h2>
                <!-- 市町村の天気予報表示-->
                <div id="openweather_city" class="d-flex mb-5"></div>
            </div>
        </div>
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-lg-8">
                <h2 class="text-white mb-4">もし、明日登山するなら</h2>
                <p class="text-white-50">
                    こんな感じの服装でどうでしょうか。服装については<a href="#">こちら</a>から。
                </p>
                <div id="best_outfit"></div>
            </div>
        </div>
    </div>
    <%= link_to mountain_courses_path(@mountain.id), class: "btn btn-primary" do %>目的地に設定する<% end %>
</section>

<section class="mtshow-section bg-light">
    <div class="container px-4 px-lg-5">
        <!-- mtshow One Row-->
        <div class="row gx-0 mb-5 mb-lg-0 justify-content-center">
            <div class="col-lg-6"><%= image_tag 'img/demo-image-01.jpg', class: 'img-fluid' %></div>
            <div class="col-lg-6">
                <div class="bg-black text-center h-100 mtshow">
                    <div class="d-flex h-100">
                        <div class="mtshow-text w-100 my-auto text-center text-lg-left">
                            <h4 class="text-white">Misty</h4>
                            <p class="mb-0 text-white-50">An example of where you can put an image of a project, or anything else, along with a description.</p>
                            <hr class="d-none d-lg-block mb-0 ms-0" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- mtshow Two Row-->
        <div class="row gx-0 justify-content-center">
            <div class="col-lg-6"><%= image_tag 'img/demo-image-02.jpg', class: 'img-fluid' %></div>
            <div class="col-lg-6 order-lg-first">
                <div class="bg-black text-center h-100 mtshow">
                    <div class="d-flex h-100">
                        <div class="mtshow-text w-100 my-auto text-center text-lg-right">
                            <h4 class="text-white">Mountains</h4>
                            <p class="mb-0 text-white-50">Another example of a project with its respective description. These sections work well responsively as well</p>
                            <hr class="d-none d-lg-block mb-0 me-0" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<script>

$(function () {
    var API_KEY = "<%= ENV['OPENWEATHER_MAP_API_KEY'] %>";
    // 山頂の経度緯度を定義
    var lat = <%= @mountain.peak_location_lat%>;
    var lon = <%= @mountain.peak_location_lng%>;
    // APIリクエストurl作成（「onecall」では7日間の天気を取得できるが日付文字列データ(dt_txt)がレスポンスに入っていないため、「5dayweatherforecast」を利用する）
    var url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + lat + '&lon=' + lon + '&units=metric&appid=' + API_KEY;
    
    $.ajax({
        url: url,
        dataType: 'json',
        type: 'GET',
    })
    .done(function (data) {
        var insertHTML = '';
        var temp_tomorrow = '';

        // デフォルトでは3時間ごとの天気を取得するため、
        // 8の倍数でデータを取得することにより、24時間ごとの天気を取得する
        for (var i = 0; i <= 32; i = i + 8) {
            insertHTML += buildHTML(data, i);
            // 明日（24時間後なので、i == 8の時）の気温を取得
            if (i == 8) {
                temp_tomorrow = data.list[i].main.temp;
            }
        }
        $('#openweather').html(insertHTML);
        
        // 明日の気温と服装の適応気温を比較し、最適な服装を表示
        var temp_summer = <%= @outfits.first.lower_limit_temp %>
        var temp_spring = <%= @outfits.second.lower_limit_temp %>
        if ( temp_summer < temp_tomorrow ){
            $("#best_outfit").html('<%= image_tag @outfits.first.image.url, class: 'img-fluid mb-3 mb-lg-0' %>');
        } else if ( temp_spring < temp_tomorrow ) {
            $("#best_outfit").html('<%= image_tag @outfits.second.image.url, class: 'img-fluid mb-3 mb-lg-0' %>');
        } else {
            $("#best_outfit").html('<%= image_tag 'baby.jpg', class: 'img-fluid' %>');
        }

        // 登山口周辺の天気予報も表示する。
        var city_id = data.city.id
        var url_city = 'https://api.openweathermap.org/data/2.5/forecast?id=' + city_id + '&units=metric&appid=' + API_KEY;
        $.ajax({
            url: url_city,
            dataType: 'json',
            type: 'GET',
        })
        .done(function (data) {
            var insertHTML_city = '';
            for (var i = 0; i <= 32; i = i + 8) {
                insertHTML_city += buildHTML(data, i);
            }
            $('#openweather_city').html(insertHTML_city);
        })
    })

    .fail(function (data) {
        alert('天気予報取得に失敗しました');
    });
});


// 日本語化 最高気温は四捨五入、最低気温は切り捨て
function buildHTML(data, i) {
    var Week = new Array('(日)', '(月)', '(火)', '(水)', '(木)', '(金)', '(土)');
    var date = new Date(data.list[i].dt_txt);
    date.setHours(date.getHours() + 9);
    var month = date.getMonth() + 1;
    var day = month + '/' + date.getDate() + Week[date.getDay()];
    var icon = data.list[i].weather[0].icon;
    var html =
    '<div class="weather-report text-white-50 mx-auto">' +
        '<img src="https://openweathermap.org/img/w/' + icon + '.png">' +
        '<span class="weather-date">' + day + "</span>" +
        '<div class="weather-temp-max">' + '最高：' + Math.round(data.list[i].main.temp_max) + "℃</div>" +
        '<span class="weather-temp-min">' + '最低：' + Math.floor(data.list[i].main.temp_min) + "℃</span>" +
    '</div>';
    return html
}

</script>